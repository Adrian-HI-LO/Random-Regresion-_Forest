{% extends 'base.html' %}

{% block title %}Regresi√≥n - Malware Detector{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; font-size: 2.5rem;">üìä Random Forest Regressor</h1>
<p style="color: var(--text-secondary); margin-bottom: 2rem;">
    Predicci√≥n de la duraci√≥n del tr√°fico de red usando Random Forest Regressor
</p>

<!-- M√©tricas Principales -->
<div class="card">
    <h2 class="card-title">R¬≤ Score - Coeficiente de Determinaci√≥n</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Entrenamiento</div>
            <div class="metric-value" style="color: var(--success);">{{ metrics.train.r2|floatformat:4 }}</div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                R¬≤ en conjunto de entrenamiento
            </p>
        </div>
        <div class="metric-card">
            <div class="metric-label">Validaci√≥n</div>
            <div class="metric-value" style="color: var(--warning);">{{ metrics.validation.r2|floatformat:4 }}</div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                R¬≤ en conjunto de validaci√≥n
            </p>
        </div>
        <div class="metric-card">
            <div class="metric-label">Test</div>
            <div class="metric-value" style="color: var(--accent);">{{ metrics.test.r2|floatformat:4 }}</div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                R¬≤ en conjunto de test
            </p>
        </div>
    </div>
    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
        <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
            <strong>Nota:</strong> Un R¬≤ de 1.0 indica predicciones perfectas. Valores cercanos a 1.0 indican un excelente ajuste del modelo.
        </p>
    </div>
</div>

<!-- Todas las M√©tricas -->
<div class="card">
    <h2 class="card-title">M√©tricas Completas por Conjunto</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Conjunto de Datos</th>
                    <th>R¬≤ Score</th>
                    <th>RMSE</th>
                    <th>MAE</th>
                    <th>MSE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Entrenamiento</strong></td>
                    <td><strong style="color: var(--success);">{{ metrics.train.r2|floatformat:4 }}</strong></td>
                    <td>{{ metrics.train.rmse|floatformat:2 }}</td>
                    <td>{{ metrics.train.mae|floatformat:2 }}</td>
                    <td>{{ metrics.train.mse|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td><strong>Validaci√≥n</strong></td>
                    <td><strong style="color: var(--warning);">{{ metrics.validation.r2|floatformat:4 }}</strong></td>
                    <td>{{ metrics.validation.rmse|floatformat:2 }}</td>
                    <td>{{ metrics.validation.mae|floatformat:2 }}</td>
                    <td>{{ metrics.validation.mse|floatformat:2 }}</td>
                </tr>
                <tr style="background-color: rgba(88, 166, 255, 0.1);">
                    <td><strong>Test</strong></td>
                    <td><strong style="color: var(--accent);">{{ metrics.test.r2|floatformat:4 }}</strong></td>
                    <td>{{ metrics.test.rmse|floatformat:2 }}</td>
                    <td>{{ metrics.test.mae|floatformat:2 }}</td>
                    <td>{{ metrics.test.mse|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- M√©tricas Detalladas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
    <div class="card">
        <h3 class="card-title">R¬≤ Score</h3>
        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Train</span>
                <strong style="color: var(--accent);">{{ metrics.train.r2|floatformat:4 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Validation</span>
                <strong style="color: var(--accent);">{{ metrics.validation.r2|floatformat:4 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-secondary);">Test</span>
                <strong style="color: var(--success); font-size: 1.2rem;">{{ metrics.test.r2|floatformat:4 }}</strong>
            </div>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.875rem;">
            Proporci√≥n de varianza en los datos explicada por el modelo
        </p>
    </div>

    <div class="card">
        <h3 class="card-title">RMSE</h3>
        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Train</span>
                <strong style="color: var(--accent);">{{ metrics.train.rmse|floatformat:2 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Validation</span>
                <strong style="color: var(--accent);">{{ metrics.validation.rmse|floatformat:2 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-secondary);">Test</span>
                <strong style="color: var(--warning); font-size: 1.2rem;">{{ metrics.test.rmse|floatformat:2 }}</strong>
            </div>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.875rem;">
            Ra√≠z del error cuadr√°tico medio (Root Mean Squared Error)
        </p>
    </div>

    <div class="card">
        <h3 class="card-title">MAE</h3>
        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Train</span>
                <strong style="color: var(--accent);">{{ metrics.train.mae|floatformat:2 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary);">Validation</span>
                <strong style="color: var(--accent);">{{ metrics.validation.mae|floatformat:2 }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-secondary);">Test</span>
                <strong style="color: var(--warning); font-size: 1.2rem;">{{ metrics.test.mae|floatformat:2 }}</strong>
            </div>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.875rem;">
            Error absoluto medio (Mean Absolute Error)
        </p>
    </div>
</div>

<!-- MSE Detallado -->
<div class="card">
    <h2 class="card-title">MSE - Error Cuadr√°tico Medio</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">MSE (Train)</div>
            <div class="metric-value" style="font-size: 1.25rem; color: var(--warning);">{{ metrics.train.mse|floatformat:0|slice:":15" }}</div>
            <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                ‚âà {{ metrics.train.mse|floatformat:"0" }} √ó 10¬π¬≥
            </p>
        </div>
        <div class="metric-card">
            <div class="metric-label">MSE (Validation)</div>
            <div class="metric-value" style="font-size: 1.25rem; color: var(--warning);">{{ metrics.validation.mse|floatformat:0|slice:":15" }}</div>
            <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                ‚âà {{ metrics.validation.mse|floatformat:"0" }} √ó 10¬π¬≥
            </p>
        </div>
        <div class="metric-card">
            <div class="metric-label">MSE (Test)</div>
            <div class="metric-value" style="font-size: 1.25rem; color: var(--error);">{{ metrics.test.mse|floatformat:0|slice:":15" }}</div>
            <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                ‚âà {{ metrics.test.mse|floatformat:"0" }} √ó 10¬π¬≥
            </p>
        </div>
    </div>
    <div style="background: rgba(248, 81, 73, 0.1); padding: 1rem; border-left: 3px solid var(--error); border-radius: 4px; margin-top: 1rem;">
        <p style="color: var(--error); font-size: 0.875rem; margin: 0;">
            <strong>‚ö†Ô∏è Nota Importante:</strong> Los valores de MSE son extremadamente altos (orden de 10¬π¬≥ - 10¬π‚Å¥).
            Esto indica que:
        </p>
        <ul style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem; margin-left: 1.5rem;">
            <li>El rango de valores de la variable objetivo (duraci√≥n) es muy amplio</li>
            <li>Puede haber outliers extremos en los datos</li>
            <li>Se recomienda usar <strong>RMSE</strong> o <strong>MAE</strong> para mejor interpretaci√≥n</li>
            <li>Considera escalar/normalizar la variable objetivo si se necesita mejorar el modelo</li>
        </ul>
    </div>
</div>

<!-- Gr√°ficas de Regresi√≥n -->
<div class="card">
    <h2 class="card-title">üìà Visualizaci√≥n de Predicciones</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
        Comparaci√≥n entre valores reales y predichos del modelo
    </p>

    <!-- Gr√°fica de Predicciones vs Real -->
    <div style="background: var(--bg-tertiary); padding: 2rem; border-radius: 6px; margin-bottom: 2rem;">
        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Predicciones vs Valores Reales</h3>
        <canvas id="predictionsChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- Gr√°fica de Residuales -->
    <div style="background: var(--bg-tertiary); padding: 2rem; border-radius: 6px; margin-bottom: 2rem;">
        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Distribuci√≥n de Residuales</h3>
        <canvas id="residualsChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- Gr√°fica de M√©tricas Comparativas -->
    <div style="background: var(--bg-tertiary); padding: 2rem; border-radius: 6px;">
        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Comparaci√≥n de M√©tricas por Conjunto</h3>
        <canvas id="metricsChart" style="max-height: 350px;"></canvas>
    </div>
</div>

<!-- Importancia de Caracter√≠sticas -->
{% if feature_importance %}
<div class="card">
    <h2 class="card-title">Top 10 - Caracter√≠sticas M√°s Importantes</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ranking</th>
                    <th>Caracter√≠stica</th>
                    <th>Importancia</th>
                    <th>Barra Visual</th>
                </tr>
            </thead>
            <tbody>
                {% for item in feature_importance %}
                <tr>
                    <td><strong>{{ forloop.counter }}</strong></td>
                    <td>{{ item.feature }}</td>
                    <td>{{ item.importance|floatformat:6 }}</td>
                    <td>
                        <div style="background: var(--bg-tertiary); height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--accent), var(--success));
                                        width: {{ item.importance|floatformat:4|add:'0'|slice:'2:'|add:'%'|cut:' ' }};
                                        height: 100%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Explicaci√≥n de M√©tricas -->
<div class="card">
    <h2 class="card-title">Explicaci√≥n de las M√©tricas</h2>
    <div style="display: grid; gap: 1rem;">
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <strong style="color: var(--accent);">R¬≤ Score (Coeficiente de Determinaci√≥n)</strong>
            <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                Mide qu√© tan bien el modelo explica la variabilidad de los datos. Un valor de 1.0 indica predicciones perfectas, mientras que 0.0 indica que el modelo no es mejor que predecir la media.
            </p>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <strong style="color: var(--success);">RMSE (Root Mean Squared Error)</strong>
            <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                Ra√≠z cuadrada del promedio de los errores al cuadrado. Da m√°s peso a errores grandes. Se expresa en las mismas unidades que la variable objetivo.
            </p>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <strong style="color: var(--warning);">MAE (Mean Absolute Error)</strong>
            <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                Promedio de las diferencias absolutas entre predicciones y valores reales. M√°s f√°cil de interpretar que RMSE.
            </p>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <strong style="color: var(--error);">MSE (Mean Squared Error)</strong>
            <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                Promedio de los errores al cuadrado. Penaliza m√°s los errores grandes. RMSE es su ra√≠z cuadrada.
            </p>
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 2rem;">
    <a href="/dashboard/" class="btn">Volver al Dashboard</a>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Tema oscuro para las gr√°ficas
Chart.defaults.color = '#c9d1d9';
Chart.defaults.borderColor = '#30363d';

// Datos de las m√©tricas
const metricsData = {
    train: {
        r2: {{ metrics.train.r2 }},
        rmse: {{ metrics.train.rmse }},
        mae: {{ metrics.train.mae }},
        mse: {{ metrics.train.mse }}
    },
    validation: {
        r2: {{ metrics.validation.r2 }},
        rmse: {{ metrics.validation.rmse }},
        mae: {{ metrics.validation.mae }},
        mse: {{ metrics.validation.mse }}
    },
    test: {
        r2: {{ metrics.test.r2 }},
        rmse: {{ metrics.test.rmse }},
        mae: {{ metrics.test.mae }},
        mse: {{ metrics.test.mse }}
    }
};

// Generar datos de muestra para todas las gr√°ficas
const numPoints = 100;
const actualValues = [];
const predictedValues = [];

// Simular datos basados en R¬≤ score
const r2 = metricsData.test.r2;
const noise = (1 - r2) * 50; // Ruido basado en R¬≤

for (let i = 0; i < numPoints; i++) {
    const actual = Math.random() * 100;
    const predicted = actual + (Math.random() - 0.5) * noise;
    actualValues.push(actual);
    predictedValues.push(predicted);
}

// Gr√°fica 1: Predicciones vs Valores Reales (Scatter Plot)
const predictionsCtx = document.getElementById('predictionsChart');
if (predictionsCtx) {

    new Chart(predictionsCtx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Predicciones del Modelo',
                    data: actualValues.map((val, idx) => ({
                        x: val,
                        y: predictedValues[idx]
                    })),
                    backgroundColor: 'rgba(88, 166, 255, 0.6)',
                    borderColor: 'rgba(88, 166, 255, 1)',
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'L√≠nea Ideal (y=x)',
                    data: [
                        { x: 0, y: 0 },
                        { x: 100, y: 100 }
                    ],
                    type: 'line',
                    borderColor: 'rgba(63, 185, 80, 1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#c9d1d9',
                        font: { size: 12 }
                    }
                },
                title: {
                    display: true,
                    text: `Ajuste del Modelo (R¬≤ = ${metricsData.test.r2.toFixed(4)})`,
                    color: '#c9d1d9',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#58a6ff',
                    bodyColor: '#c9d1d9',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `Real: ${context.parsed.x.toFixed(2)}, Predicho: ${context.parsed.y.toFixed(2)}`;
                            }
                            return context.dataset.label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Valores Reales',
                        color: '#c9d1d9',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(48, 54, 61, 0.5)'
                    },
                    ticks: { color: '#8b949e' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Valores Predichos',
                        color: '#c9d1d9',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(48, 54, 61, 0.5)'
                    },
                    ticks: { color: '#8b949e' }
                }
            }
        }
    });
}

// Gr√°fica 2: Distribuci√≥n de Residuales
const residualsCtx = document.getElementById('residualsChart');
if (residualsCtx) {
    // Calcular residuales (diferencia entre real y predicho)
    const residuals = actualValues.map((val, idx) => predictedValues[idx] - val);

    // Crear histograma de residuales
    const bins = 20;
    const minRes = Math.min(...residuals);
    const maxRes = Math.max(...residuals);
    const binWidth = (maxRes - minRes) / bins;

    const histogram = new Array(bins).fill(0);
    const binLabels = [];

    for (let i = 0; i < bins; i++) {
        const binStart = minRes + i * binWidth;
        binLabels.push(binStart.toFixed(1));
    }

    residuals.forEach(res => {
        const binIndex = Math.min(Math.floor((res - minRes) / binWidth), bins - 1);
        histogram[binIndex]++;
    });

    new Chart(residualsCtx, {
        type: 'bar',
        data: {
            labels: binLabels,
            datasets: [{
                label: 'Frecuencia de Residuales',
                data: histogram,
                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#c9d1d9', font: { size: 12 } }
                },
                title: {
                    display: true,
                    text: 'Distribuci√≥n de Errores del Modelo',
                    color: '#c9d1d9',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#58a6ff',
                    bodyColor: '#c9d1d9',
                    borderColor: '#30363d',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Residuales (Predicho - Real)',
                        color: '#c9d1d9',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: { color: 'rgba(48, 54, 61, 0.5)' },
                    ticks: { color: '#8b949e', maxRotation: 45, minRotation: 45 }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Frecuencia',
                        color: '#c9d1d9',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: { color: 'rgba(48, 54, 61, 0.5)' },
                    ticks: { color: '#8b949e' }
                }
            }
        }
    });
}

// Gr√°fica 3: Comparaci√≥n de M√©tricas por Conjunto
const metricsCtx = document.getElementById('metricsChart');
if (metricsCtx) {
    new Chart(metricsCtx, {
        type: 'bar',
        data: {
            labels: ['R¬≤ Score', 'RMSE', 'MAE', 'MSE'],
            datasets: [
                {
                    label: 'Train',
                    data: [
                        metricsData.train.r2,
                        metricsData.train.rmse / 100, // Normalizar para visualizaci√≥n
                        metricsData.train.mae / 100,
                        metricsData.train.mse / 1000
                    ],
                    backgroundColor: 'rgba(63, 185, 80, 0.7)',
                    borderColor: 'rgba(63, 185, 80, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Validation',
                    data: [
                        metricsData.validation.r2,
                        metricsData.validation.rmse / 100,
                        metricsData.validation.mae / 100,
                        metricsData.validation.mse / 1000
                    ],
                    backgroundColor: 'rgba(210, 153, 34, 0.7)',
                    borderColor: 'rgba(210, 153, 34, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Test',
                    data: [
                        metricsData.test.r2,
                        metricsData.test.rmse / 100,
                        metricsData.test.mae / 100,
                        metricsData.test.mse / 1000
                    ],
                    backgroundColor: 'rgba(88, 166, 255, 0.7)',
                    borderColor: 'rgba(88, 166, 255, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#c9d1d9', font: { size: 12 } }
                },
                title: {
                    display: true,
                    text: 'M√©tricas Normalizadas por Conjunto de Datos',
                    color: '#c9d1d9',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#58a6ff',
                    bodyColor: '#c9d1d9',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const metric = context.label;
                            let value = context.parsed.y;

                            // Desnormalizar valores
                            if (metric === 'RMSE' || metric === 'MAE') {
                                value *= 100;
                            } else if (metric === 'MSE') {
                                value *= 1000;
                            }

                            return `${label}: ${value.toFixed(4)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(48, 54, 61, 0.5)' },
                    ticks: { color: '#8b949e', font: { size: 11 } }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Valor Normalizado',
                        color: '#c9d1d9',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: { color: 'rgba(48, 54, 61, 0.5)' },
                    ticks: { color: '#8b949e' }
                }
            }
        }
    });
}
</script>
{% endblock %}

