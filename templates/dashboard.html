{% extends 'base.html' %}

{% block title %}Dashboard - Malware Detector{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; font-size: 2.5rem;">Dashboard - An√°lisis Completo</h1>

<!-- Informaci√≥n del Dataset -->
{% if dataset_info %}
<div class="card" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d1b3d 100%); border-color: #4a5568; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h3 style="color: #fbbf24; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
                Configuraci√≥n del Dataset
            </h3>
            {% if dataset_info.using_subset %}
            <p style="color: #cbd5e0; font-size: 0.95rem; margin: 0;">
                ‚ö†Ô∏è <strong>Modo Memoria Limitada:</strong> Usando subset de <strong style="color: #60a5fa;">{{ dataset_info.subset_size|floatformat:0 }}</strong> filas
                ({{ dataset_info.percentage_used }}% del dataset completo)
            </p>
            <p style="color: #9ca3af; font-size: 0.875rem; margin-top: 0.25rem;">
                Dataset completo: {{ dataset_info.full_dataset_size|floatformat:0 }} filas
            </p>
            {% else %}
            <p style="color: #10b981; font-size: 0.95rem; margin: 0;">
                ‚úì <strong>Usando dataset completo:</strong> {{ dataset_info.full_dataset_size|floatformat:0 }} filas
            </p>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <div style="background: rgba(96, 165, 250, 0.1); padding: 0.75rem 1.5rem; border-radius: 6px; border: 1px solid rgba(96, 165, 250, 0.3);">
                <div style="color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Filas Usadas</div>
                <div style="color: #60a5fa; font-size: 1.75rem; font-weight: 700; line-height: 1;">
                    {{ dataset_info.subset_size|floatformat:0 }}
                </div>
            </div>
        </div>
    </div>
    {% if dataset_info.using_subset %}
    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
        <p style="color: #fbbf24; font-size: 0.875rem; margin: 0;">
            <strong>üí° Nota:</strong> Para usar m√°s datos, configura la variable de entorno <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem; border-radius: 3px;">DATASET_SUBSET_SIZE</code> en Render.
            ‚ö†Ô∏è Valores muy altos (>100,000) pueden causar errores de memoria en el plan Free.
        </p>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Clasificaci√≥n -->
<div class="card">
    <h2 class="card-title">RFC Random Forest Classifier</h2>
    <h3 style="color: var(--text-secondary); margin-bottom: 1.5rem;">Detecci√≥n de Malware</h3>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">F1 Score (Train)</div>
            <div class="metric-value">{{ clf_metrics.train.f1_score|floatformat:4 }}</div>
            <span class="badge badge-success">Entrenamiento</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">F1 Score (Validation)</div>
            <div class="metric-value">{{ clf_metrics.validation.f1_score|floatformat:4 }}</div>
            <span class="badge badge-warning">Validaci√≥n</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">F1 Score (Test)</div>
            <div class="metric-value">{{ clf_metrics.test.f1_score|floatformat:4 }}</div>
            <span class="badge badge-success">Test</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">Accuracy (Test)</div>
            <div class="metric-value">{{ clf_metrics.test.accuracy|floatformat:4 }}</div>
            <span class="badge badge-success">Test</span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <div style="color: var(--text-secondary); font-size: 0.875rem;">Precision (Test)</div>
            <div style="font-size: 1.5rem; color: var(--accent);">{{ clf_metrics.test.precision|floatformat:4 }}</div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <div style="color: var(--text-secondary); font-size: 0.875rem;">Recall (Test)</div>
            <div style="font-size: 1.5rem; color: var(--accent);">{{ clf_metrics.test.recall|floatformat:4 }}</div>
        </div>
    </div>
</div>

<!-- Regresi√≥n -->
<div class="card">
    <h2 class="card-title">RFR Random Forest Regressor</h2>
    <h3 style="color: var(--text-secondary); margin-bottom: 1.5rem;">Predicci√≥n de Duraci√≥n del Tr√°fico</h3>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">R¬≤ Score (Train)</div>
            <div class="metric-value">{{ reg_metrics.train.r2|floatformat:4 }}</div>
            <span class="badge badge-success">Entrenamiento</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">R¬≤ Score (Validation)</div>
            <div class="metric-value">{{ reg_metrics.validation.r2|floatformat:4 }}</div>
            <span class="badge badge-warning">Validaci√≥n</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">R¬≤ Score (Test)</div>
            <div class="metric-value">{{ reg_metrics.test.r2|floatformat:4 }}</div>
            <span class="badge badge-success">Test</span>
        </div>
        <div class="metric-card">
            <div class="metric-label">RMSE (Test)</div>
            <div class="metric-value">{{ reg_metrics.test.rmse|floatformat:2 }}</div>
            <span class="badge badge-warning">Test</span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <div style="color: var(--text-secondary); font-size: 0.875rem;">MSE (Test)</div>
            <div style="font-size: 1.5rem; color: var(--accent);">{{ reg_metrics.test.mse|floatformat:2 }}</div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <div style="color: var(--text-secondary); font-size: 0.875rem;">MAE (Test)</div>
            <div style="font-size: 1.5rem; color: var(--accent);">{{ reg_metrics.test.mae|floatformat:2 }}</div>
        </div>
    </div>
</div>

<!-- Comparaci√≥n de Conjuntos -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <div class="card">
        <h3 class="card-title">Clasificaci√≥n - Todas las M√©tricas</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Conjunto</th>
                        <th>Accuracy</th>
                        <th>Precision</th>
                        <th>Recall</th>
                        <th>F1 Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Train</strong></td>
                        <td>{{ clf_metrics.train.accuracy|floatformat:4 }}</td>
                        <td>{{ clf_metrics.train.precision|floatformat:4 }}</td>
                        <td>{{ clf_metrics.train.recall|floatformat:4 }}</td>
                        <td>{{ clf_metrics.train.f1_score|floatformat:4 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Validation</strong></td>
                        <td>{{ clf_metrics.validation.accuracy|floatformat:4 }}</td>
                        <td>{{ clf_metrics.validation.precision|floatformat:4 }}</td>
                        <td>{{ clf_metrics.validation.recall|floatformat:4 }}</td>
                        <td>{{ clf_metrics.validation.f1_score|floatformat:4 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Test</strong></td>
                        <td>{{ clf_metrics.test.accuracy|floatformat:4 }}</td>
                        <td>{{ clf_metrics.test.precision|floatformat:4 }}</td>
                        <td>{{ clf_metrics.test.recall|floatformat:4 }}</td>
                        <td>{{ clf_metrics.test.f1_score|floatformat:4 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Regresi√≥n - Todas las M√©tricas</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Conjunto</th>
                        <th>R¬≤</th>
                        <th>RMSE</th>
                        <th>MAE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Train</strong></td>
                        <td>{{ reg_metrics.train.r2|floatformat:4 }}</td>
                        <td>{{ reg_metrics.train.rmse|floatformat:2 }}</td>
                        <td>{{ reg_metrics.train.mae|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Validation</strong></td>
                        <td>{{ reg_metrics.validation.r2|floatformat:4 }}</td>
                        <td>{{ reg_metrics.validation.rmse|floatformat:2 }}</td>
                        <td>{{ reg_metrics.validation.mae|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Test</strong></td>
                        <td>{{ reg_metrics.test.r2|floatformat:4 }}</td>
                        <td>{{ reg_metrics.test.rmse|floatformat:2 }}</td>
                        <td>{{ reg_metrics.test.mae|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
    <a href="/classification/" class="btn">Ver Detalles de Clasificaci√≥n</a>
    <a href="/regression/" class="btn">Ver Detalles de Regresi√≥n</a>
</div>
{% endblock %}

